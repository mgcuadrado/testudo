% Copyright © 2020 Miguel González Cuadrado <mgcuadrado@gmail.com>

% This file is part of Testudo.

%     Testudo is free software: you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation, either version 3 of the License, or
%     (at your option) any later version.

%     Testudo is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.

%     You should have received a copy of the GNU General Public License
%     along with Testudo.  If not, see <http://www.gnu.org/licenses/>.

\documentclass[twoside, a4paper, article]{memoir}
%\documentclass[oneside, 11pt, a5paper, article]{memoir}

\usepackage[spanish, british]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{amsmath, amssymb, graphicx, wasysym, bm, fancyvrb, soul}
\usepackage[final]{listings}
\usepackage{tikz, tikzpeople, pgfornament}
\usetikzlibrary{automata}

\newcommand*\testudocolor{\color{red!80!blue}}
\newcommand*\testudo[1]{\texttt{\testudocolor{}#1}}
\newcommand*\testudopair[2]{\testudo{#1}~--~\testudo{#2}}
\newcommand*\keywordcolor{\color{blue!80!red}}
\sethlcolor{red}

\newcommand\chaptertestudopair[3]{%
  \chapter[#1]{#1: \testudopair{#2}{#3}}}
\newcommand\sectiontestudopair[3]{%
  \section[#1]{#1: \testudopair{#2}{#3}}}
\newcommand\subsectiontestudopair[3]{%
  \subsection[#1]{#1: \testudopair{#2}{#3}}}
\newcommand\subsubsectiontestudopair[3]{%
  \subsubsection[#1]{#1: \testudopair{#2}{#3}}}

\newcommand*\ok[1]{\textcolor{green}{#1}}
\newcommand*\fail[1]{\textcolor{red}{#1}}
\newcommand*\blue[1]{\textcolor{blue}{#1}}
\newcommand*\lines[1]{\textcolor{orange}{#1}}
\newcommand*\openbrace{\{}
\newcommand*\closebrace{\}}
\newcommand*\atsign{@}

\newcommand*{\cpplistingindent}{1.7em}
\input{keywords.tex}

\newcommand*\commonlistinglstset{%
  \lstset{numbers=left,numberstyle=\tiny, stepnumber=1, numbersep=1em,
    xleftmargin=\cpplistingindent,
    lineskip=0.05pt, % this closes a gap that appears above the line whenever
                     % there are brackets in a comment
    columns=fullflexible,
    basicstyle=\ttfamily,
    keywordstyle=\ttfamily\bfseries,
    emphstyle=\ttfamily\testudocolor{},
    commentstyle=\rmfamily\itshape,
    resetmargins=true,
    backgroundcolor=\color{black!5},
    showstringspaces=false, keepspaces=true, texcl=true, escapechar=|
  }%
}
\newcommand*\cpplistinglstset{%
  \commonlistinglstset{}%
  \lstset{language=[testudo]C++}%
}
\lstnewenvironment{cpplisting}[1][]{%
  \cpplistinglstset{}%
  \lstset{#1}}{}

\newcommand*\bashlistinglstset{%
  \commonlistinglstset{}%
  \lstset{language=bash,
    backgroundcolor=\color{blue!5},
  }%
}
\lstnewenvironment{bashlisting}[1][]{%
  \bashlistinglstset{}%
  \lstset{#1}}{}

\newcommand*\makelistinglstset{%
  \commonlistinglstset{}%
  \lstset{language=make,
    backgroundcolor=\color{red!5},
  }%
}
\lstnewenvironment{makelisting}[1][]{%
  \makelistinglstset{}%
  \lstset{#1}}{}

\usepackage{microtype}
%% \usepackage[textosf, mathlf, italicgreek, openg, footnotefigures%, opticals
%% ]%
%% {MinionPro} % no minionint since it fails
\usepackage{lmodern} % for the bold tt
\usepackage[oldstyle, altP, sups]{fbb}

\usepackage[pdfborder={0 0 0}]{hyperref}

%\setlrmarginsandblock{1cm}{1cm}{*}
%\setulmarginsandblock{2cm}{2cm}{*}
%\checkandfixthelayout

\newcommand*\ellipsis{\,\ldots}
\newcommand*\Cpp{C\texttt{++}}

\firmlists

\newcommand*\indentitem{\hspace*{1em}}

\title{\protect\includegraphics[width=\textwidth]%
  {ascii_logo_colour_cropped.pdf}\\[1em]Testudo,\\an automatic test system\\for
  \Cpp{} code\\[1em](version \protect\input{version}\unskip)}

\author{Miguel González Cuadrado\\\textsf{<mgcuadrado@gmail.com>}}

\maxsecnumdepth{subsection}
\maxtocdepth{subsection}

\begin{document}

\frontmatter

\maketitle

\tableofcontents*
\listoffigures*
\listoftables*

\cleartooddpage

\begin{quote}
  \emph{This manual is in its early stages.  I'm going first for completeness,
    not for clarity.  My plans: finish covering the functionality of Testudo,
    convert into a web-friendly format, turn it into a guide rather than a
    dense reference.}
\end{quote}

\chapter{Intro}
\label{cha:intro}

Automatic testing: unit testing, integrated testing, test-driven
development\ellipsis{}  You can do all of these with Testudo.

Brief rundown of Testudo's features:
\begin{itemize}
\item tree-like organisation of tests (\Sref{cha:tests-test-hierarchies});
\item execution of selected tests;
\item easy definition of tests (\Sref{cha:test-steps});
\item clear, complete, flexible test reports;
\item straightforward syntax for declarations, actions, showing values, checks
  on values, predicate checks, and scopes (\Sref{cha:test-steps});
\item support for exception checks (\Sref{sec:exception-checks}) and unexpected
  exceptions (\Sref{sec:unexpected-exceptions});
\item support for complex types (\Sref{cha:testudo-support-stl-types});
\item easy support for new types (\Sref{cha:adding-testudo-support-your-types});
\item fixtures (\Sref{cha:fixtures});
\item repeating steps for many values, like theorem checking
  (\Sref{cha:with-data-loops});
\item mock objects (\Sref{cha:mock-objects}).
\end{itemize}

\vspace{1\baselineskip}

\begin{quote}
  \emph{``Testudo'' means ``turtle'' in Esperanto and Latin.  The name of the
    turtle in the logo (see the title of this document) is Testarudo, which
    means ``stubborn'' in Spanish.  Testarudo is indefatigable, and will
    tenaciously flag you errors, until you correct them.}
\end{quote}

\vspace{1\baselineskip}

Testudo runs a suite of tests specified by the user, and produces an
\textsc{xml} printout of the results.  You can convert the \textsc{xml} file
into a variety of formats, for immediate perusal, result tracking, statistics,
publication, et cetera.  The blue question mark and the green \verb|[ OK ]| and
red \verb|[FAIL]| flags in the logo are a reference to the way instructions,
passes, and fails are displayed when a test result is converted to a text
report with colours\footnote{Colour-blind-friendly, by the way.}.

A \emph{test suite} in Testudo is composed of an ordered series of
\emph{tests}, each test consisting of a sequence of \emph{steps}.  Tests are
organised as a tree, with test nodes, and proper tests on some test nodes.

When a test suite is run, all tests are performed in order, according to their
position in the test tree, and within each test, the test steps are executed in
order.  Some test steps are \emph{checks}, which can succeed or fail.  Check
successes and failures are tallied and summarised at the end of their test.
Accumulated tallies are also kept for each test node, which combine the tallies
of the sub-tree rooted at each test node.

\section{Macros}
\label{sec:macros}

Testudo relies rather heavily on code generation with \Cpp{} macros.  As
explained in~\Sref{cha:test-output-formats}, you can customise the names of all
the macros to suit your needs or preferences.  In the examples given in this
documents, macros are highlighted like this (here, the macro is
``\texttt{PERFORM}''):
\begin{cpplisting}
PERFORM(firefly.say("Then, it's war!"));
\end{cpplisting}

Testudo macros are coded in such a way that they are impervious to the common
problem of macro arguments containing commas, like for instance in templated
types, which would normally confuse \Cpp{} macros (an argument such as
``\texttt{map<int, float>}'' would be parsed as two arguments:
``\texttt{map<int}'' and ``\texttt{float>}'').  Testudo achieves this by one of
two means:
\begin{itemize}
\item having a single potentially macro-fooling argument for a macro, and
  having it be the last one;
\item requiring parentheses around potentially macro-fooling arguments (this
  will always be made clear in this document).
\end{itemize}

\section{The \texttt{testudo} namespace}
\label{sec:testudo-namespace}

All (non-macro) names defined by Testudo that are intended for usage by users
are defined in the ``\texttt{testudo}'' namespace.  This namespace will left
out in the examples, as if ``\texttt{using namespace testudo}'' had been
declared.

\section{Showcase: code, test, and report}
\label{sec:showcase}

As a quick, self-paced introduction to Testudo test step syntax, i've laid out
hereafter the source code for a class, the source code for a test for the
functionality, and the resulting test report.  If my \LaTeX{} trickery doesn't
fail me, and you have printed this on physical paper, you'll have the source
code for the test and the test report on opposite pages
(pages~\pageref{pag:example-test-code} and~\pageref{pag:example-test-report}),
so you can't better understand how one relates to the other.

The code is meant for this showcase, not for production, and shouldn't be
construed as an example of good coding: you'll see questionably design and
coding practices; you'll see bugs and unimplemented functionality so they can
be pointed out in the report as test fails; you'll see weird vertical spacing
to achieve syncing between the two printed pages; and you'll see too many
concerns crammed into a single test.

\cleartooddpage

{%
  \cpplistinglstset{}%
  \lstinputlisting[language={[testudo]C++}]{testudo_doc.ttd}
}

\newpage

\label{pag:example-test-report}

\input{reports/testudo.use_instructions.tex}

\mainmatter


\chapter{Test output formats}
\label{cha:test-output-formats}

When a test suite is run, Testudo outputs a printout detailing each test node,
test, test step, and tallies.  There are several formats for the printout.  You
must choose the format by passing to the executable the flag ``\texttt{-f}''
followed by the name of the format.  Standard formats are ``\texttt{xml}'' and
``\texttt{color\_text}'', but you can add your own.

The ``\texttt{xml}'' format outputs the printout in \textsc{xml} format.  This
format records all details of the test suite, and is meant for consumption by
an \textsc{xml} parser.  The available parser is ``\texttt{xml\_to\_color}'',
which by default converts the printout to a full text report with colours.
With the flag ``\texttt{-b}'', the output is identical but with no colours.
With ``\texttt{-s}'', the output is only a summary, giving the check statistics
for each test node and each test.  The default version uses the \textsc{xslt}
file ``\texttt{testarudo.xslt}'' to interpret all possible elements and
attributes in the \textsc{xml} printout.

The ``\texttt{color\_text}'' format outputs the printout directly as a full
text report with colours, virtually identical to the one
``\texttt{xml\_to\_color}'' produces.  The difference is that this format
produces its output synchronously, so even if a fatal error happens, you'll get
the whole output until just before the error, whereas the ``\texttt{xml}''
won't output anything\footnote{This is so because the ``\texttt{xml}'' format
  first builds the whole \textsc{xml} object for the printout before printing
  it.}.


\chapter{Test definition and test instruction styles}
\label{cha:test-definition-test-instruction-styles}

All test instructions described in this section are implemented as \Cpp{}
macros.  You can choose among different styles for the macro names, or even
rename them altogether to your liking
(see~\Sref{cha:using-your-own-test-macro-names}).
Out-of-the-box, the available styles are:
\begin{itemize}
\item ``\texttt{lc}'' (lowercase), where all macro names are in lowercase, and
  continuing macros have a leading underscore, so that they can be stuck to the
  preceding expression nicely; this style is easy on the eyes, but may be too
  cluttered for some people; here's an example:
\begin{cpplisting}
declare(int a=7); // declare a variable
check(a+2)_equal(9); // check for equality
\end{cpplisting}

\item ``\texttt{uc}'' (uppercase), where all macro names are in uppercase, and
  continuing macros are expected to be separated from the preceding expression
  by a space; this style shows clearly the parts of check instructions, but may
  be excessively macroish; here's the same example as for ``\texttt{lc}'', but
  in ``\texttt{uc}'' style:
\begin{cpplisting}
DECLARE(int a = 7); // declare a variable
CHECK(a + 2) EQUAL(9); // check for equality
\end{cpplisting}
\end{itemize}

See~\tref{tab:style-table} for a list of all macro syntax names, with their
macro name in the ``\texttt{lc}'' and ``\texttt{uc}'' styles.

\begin{table}
  \centering
  \begin{footnotesize}
    \input{style_table.tex}
  \end{footnotesize}
  \caption{Macro names in the default styles}
  \label{tab:style-table}
\end{table}

Whatever the style you choose, your editor may help you writing and reading
test instructions, for instance by giving them a specific colour;
see~\Sref{cha:editor-configuration} for details.

In the following sections, matching ``\texttt{lc}'' and ``\texttt{uc}'' test
instruction names are shown in the subsection titles, and all examples are
given first in the ``\texttt{lc}'', cluttered style, then in the
``\texttt{uc}'', open style.


\chapter{How to use Testudo}
\label{cha:how-to-use}

First, choose a macro style
(see~\Sref{cha:test-definition-test-instruction-styles}).  Then, generate a
header file for your style using the script ``\texttt{generate\_style}'' (this
is done automatically if you use ``\texttt{make}'').  Finally, include the
generated header file in your \Cpp{} test source file.  For instance, if you
want to use the default upper-case macro style, do
\begin{cpplisting}
#include "testudo_uc.h"
\end{cpplisting}

Additionally, if you require support for \textsc{stl} types, include
``\texttt{testudo\_ext.h}'':
\begin{cpplisting}
#include "testudo_ext.h"
\end{cpplisting}

You can give your \Cpp{} test source file any extension, but if you give it the
``\texttt{.ttd}'' extension, ``\texttt{make}'' will detect it as a test file
and compile it correctly.


\chapter{Tests and test hierarchies}
\label{cha:tests-test-hierarchies}

Tests are organised in a tree where each node, be it leaf or not, may or may
not have an associated test.  You can choose to execute the tests in a sub-tree
rooted at any node.

In this context, \emph{declaring} a test node means mentioning it by full name.
If a test node with the appropriate full name exists already, the mention
refers to it.  Otherwise, a new test node is created, with no title, test
function, or priority.  On the other hand, \emph{defining} a test node or a
test means giving it full contents, including at least a name and a title, but
possibly also a test function or a priority.

Test nodes and tests are declared and defined in any number of \Cpp{}
translation units; each declaration or definition causes an action on the test
tree (the creation or configuration of a node).  We can't control the order in
which translation units are executed, but Testudo gives you means to control
the order of execution of tests.

Nodes you define as siblings (i.e., with the same parent) in a given
translation unit will be created in the order they are mentioned in the code,
and will be run in that same order.  For sibling nodes that aren't defined in
the same translation unit, you can control the order in which they are executed
by giving each one a different priority (a non-negative number); nodes with
lower priority come first.  If two sibling nodes have the same priority,
Testudo resorts to alphabetical ordering.

Test nodes have two kinds of names: the name and the full name.  The ``name''
proper is a string with no periods or spaces in it, and represents the name the
node has \emph{relative to its parent}.  A test node can't have two children
with the same name.  The full name of a test node is obtained by chaining all
the names of its ancestors in order, finishing with its own name, separated by
periods.  The \emph{title} of a test node is an arbitrary string.

\section{Non-top test nodes}
\label{sec:non-top-test-nodes}

When you declare or define a test node whose parent has been defined in the
current translation unit\footnote{I call these non-top test nodes in opposition
  to top test nodes; see~\Sref{sec:top-test-nodes}.  Another name could have
  been ``child nodes'', since they are children to parents that have been
  defined in the same translation unit.}, use the ``define-test-node'' or
``define-test'' syntaxes.  As explained before, the execution order is the
order in the code, so no priority is specified.

So, for instance, if you have already defined a test node called
``\texttt{tricorder}'', here's how to define a child test node called
``\texttt{medical}'', with the title ``medical capabilities'':
\begin{cpplisting}
define_test_node(tricorder, medical, "medical capabilities");
\end{cpplisting}

\begin{cpplisting}
DEFINE_TEST_NODE(tricorder, medical, "medical capabilities");
\end{cpplisting}

For a test (a test node with a test function), the syntax includes the
definition of the test function itself, as if it were a regular \Cpp{}
function, only with its declarator part (the one where you specify the return
type, the function name, and the parameters) replaced by a Testudo macro.  If
you have already defined a test node called ``\texttt{medical}'', here's how to
define a child test called ``\texttt{switch\_on}'', titled ``switch on after
creation'', that checks a tricorder medical sub-unit is off upon creation of the
tricorder, and switches on appropriately:
\begin{cpplisting}
define_test(medical, switch_on, "switch on after") {
  declare(Tricorder t); // see~\Sref{cha:test-steps} for the test steps syntax
  check(not t.medical.is_on())_true;
  perform(t.medical.push_on_button());
  check(t.medical.is_on())_true;
}
\end{cpplisting}

\begin{cpplisting}
DEFINE_TEST(medical, switch_on, "switch on after")
{
  DECLARE(Tricorder t); // see~\Sref{cha:test-steps} for the test steps syntax
  CHECK(not t.medical.is_on()) TRUE;
  PERFORM(t.medical.push_on_button());
  CHECK(t.medical.is_on()) TRUE;
}
\end{cpplisting}

\section{Top test nodes}
\label{sec:top-test-nodes}

Top test nodes are test nodes whose parent you haven't defined in the same
translation unit.  You mention their parent by their full name, and Testudo
makes sure the parent exists before the new child is defined.  Test nodes
created by mentioning their full name begin as \emph{unconfigured} test nodes;
that's \textsc{ok}, and it won't cause any harm, but it means that you're not
controlling their relative order to other test nodes (the order is still
deterministic, though, since they get a default priority of \texttt{0}), and
they don't have any title.  You can \emph{configure} an unconfigured test node
by simply defining it, preferably at an appropriately higher-level translation
unit, for clarity.

Here's how to define a top test node called ``\texttt{flux\_capacitor}'', child
to a test node whose full name is ``\texttt{outatime.delorean}'':
\begin{cpplisting}
define_top_test_node("outatime.delorean", // parent full name
                     flux_capacitor, // name
                     "flux capacitor features", // title
                     200); // priority
\end{cpplisting}

\begin{cpplisting}
DEFINE_TOP_TEST_NODE("outatime.delorean", // parent full name
                     flux_capacitor, // name
                     "flux capacitor features", // title
                     200); // priority
\end{cpplisting}

You can also define a top test (a top test node with a test function).  So,
here's how to define a test called ``\texttt{doors\_closed\_on\_start}'', child
to a test node whole full name is ``\texttt{outatime.delorean}'':
\begin{cpplisting}
define_top_test("outatime.delorean", // parent full name
                doors_closed_on_start, // name
                "doors closed after construction", // title
                150) { // priority
  declare(Delorean d);
  check(not d.left_door.is_open())_true;
  check(not d.right_door.is_open())_true;
}
\end{cpplisting}

\begin{cpplisting}
DEFINE_TOP_TEST("outatime.delorean", // parent full name
                doors_closed_on_start, // name
                "doors closed after construction", // title
                150) // priority
{
  DECLARE(Delorean d);
  CHECK(not d.left_door.is_open()) TRUE;
  CHECK(not d.right_door.is_open()) TRUE;
}
\end{cpplisting}


\chapter{Test steps}
\label{cha:test-steps}

You write a test function by declaring variables, performing actions, and
checking their results.  You must do these things in a particular way so they
end up in the test report.  This results in a test report that is easily
readable and contains all information needed to understand the test.  You can
additionally print messages to aid the comprehension, or display separators to
show a shift in the test focus.

\section{Declarations and actions}
\label{sec:declarations-actions}

Declarations and actions are about code that makes it verbatim through the
macros into the final \Cpp{} code for the test program.  The difference is that
declarations introduce names that are valid until the end of the scope, and
actions don't.  An easy way to distinguish them is to ask yourself if the
instruction has the same effect if you surround it in curly braces; if it does,
it's an action. Otherwise, it's a declaration.

Examples of declarations are:
\begin{itemize}
\item variable declarations
\begin{cpplisting}
int n=7;
\end{cpplisting}

\item using-declarations
\begin{cpplisting}
using std::vector;
\end{cpplisting}

\item using-directives
\begin{cpplisting}
using namespace std;
\end{cpplisting}
\end{itemize}

Examples of actions are:
\begin{itemize}
\item variable assignments
\begin{cpplisting}
n=8;
\end{cpplisting}

\item function invocations
\begin{cpplisting}
std::sort(v.begin(), v.end());
\end{cpplisting}
\end{itemize}

\subsectiontestudopair{Declaration}{declare}{DECLARE}
\label{sec:declaration}

All declarations in a test must be enclosed in a ``declare'' instruction.  They
will be carried out as written, and written out to the report.
\begin{cpplisting}
declare(using namespace std);
declare(pair<int, double> p={2, 3.5});
\end{cpplisting}

\begin{cpplisting}
DECLARE(using namespace std);
DECLARE(pair<int, double> p = { 2, 3.5 });
\end{cpplisting}

\subsectiontestudopair{Action}{perform}{PERFORM}
\label{sec:action}

All non-declaration instructions in a test must be enclosed in a ``perform''
instruction.  They will be carried out as written, and written to the report.
\begin{cpplisting}
perform(p.first+=10);
\end{cpplisting}

\begin{cpplisting}
PERFORM(p.first += 10);
\end{cpplisting}


\section{Checks}
\label{sec:checks}

A check instruction is a verification made on the value of an expression.  It's
outcome is true or false.  If true, it counts towards the tally of succeeded
checks.  If false, it counts towards the tally of failed checks.

\subsectiontestudopair{Checked expression}{check}{CHECK}
\label{sec:checked-expression}

An expression-check instruction starts with a ``check'' instruction containing
the value to check (usually an expression resulting from previous actions); it
must be followed by at least one continuing macro, stating what the expected
value of the expression is, and how the comparison is done.

A check where the argument to the ``check'' instruction is \emph{invalid}
always fails, no matter what the continuing macro says.  Values are considered
\emph{valid} by default, but you can tailor the definition of validity for a
type to suit your needs, by defining an ``\texttt{is\_valid()}'' method or
function (see~\Sref{sec:validity}).  The effect cannot achieved by checking for
validity in the definition of ``\texttt{operator==()}'', because if you did,
negated checks (``false'' macro, ``not-equal'' macro, et cetera) on invalid
values would be successful.

\subsectiontestudopair{Check the expression is true}{\_true}{TRUE}
\label{sec:check-expression-true}

In order to check the value of the expression for trueness, attach the ``true''
macro to the ``check'' instruction: the expression is converted to
``\texttt{bool}'', and the test check is successful if and only if the
resulting bool is true.

\begin{cpplisting}
check(dispersion_rate<(1./accuracy))_true;
\end{cpplisting}

\begin{cpplisting}
CHECK(dispersion_rate < (1. / accuracy)) TRUE;
\end{cpplisting}

\subsectiontestudopair{Check the expression is false}{\_false}{FALSE}
\label{sec:check-expression-true}

The opposite of the ``true'' macro is the ``false'' macro.  With the ``false''
macro, the test output marks this check with the word ``nay''\footnote{I've
  chosen the word ``nay'' rather than the word ``not'' to avid confusion:
  imagine seeing a check for ``\texttt{not a and b}'', which should be
  equivalent to ``\texttt{(not a) and b}'' rather than ``\texttt{not (a and
    b)}''.  No such confusion with ``\texttt{nay a and b}''.}.

\begin{cpplisting}
check(dispersion_rate<(1./accuracy))_false;
\end{cpplisting}

\begin{cpplisting}
CHECK(dispersion_rate < (1. / accuracy)) FALSE;
\end{cpplisting}

\subsectiontestudopair{Check the expression is equal to a reference}%
  {\_equal}{EQUAL}
\label{sec:check-expression-equal-reference}

In order to check whether the value of the expression is equal to a reference,
attach the ``equal'' macro to the ``check'' instruction, giving it an argument
stating the reference value.  Testudo uses ``\texttt{operator==()}'' to
compare the two values, and the test check is successful if and only if the
result of the comparison is true.

\begin{cpplisting}
check(captain_age)_equal(26+10);
\end{cpplisting}

\begin{cpplisting}
CHECK(captain_age) EQUAL(26 + 10);
\end{cpplisting}

The opposite of the ``equal'' macro is the ``not-equal'' macro:
\begin{center}
  \testudopair{\_not\_equal}{NOT\_EQUAL}
\end{center}

The expression in the ``equal'' and ``not-equal'' macros is prefixed with the
type of the expression in the ``check'' instruction, so you can leave out the
type in many cases that would otherwise require more verboseness.  So, for
instance, if ``\texttt{inventory}'' has type ``\texttt{map<string, int>}'', the
following two checks are equivalent:
\begin{cpplisting}
check(inventory)
  _equal(map<string, int>{{"apple", 2}, {"banana", 3}});
check(inventory)_equal({{"apple", 2}, {"banana", 3}});
\end{cpplisting}

\begin{cpplisting}
CHECK(inventory)
  EQUAL(map<string, int>{ { "apple", 2 }, { "banana", 3 } });
CHECK(inventory) EQUAL({ { "apple", 2 }, { "banana", 3 } });
\end{cpplisting}


\subsectiontestudopair{Check the expression is near a reference}%
  {\_approx}{APPROX}
\label{sec:check-expression-near-reference}

For non-discrete types (floating-point, for instance), checking for equality
isn't useful, as tiny rounding errors would make such a test fail\footnote{In
  fact, when working with floating-point magnitudes, you should instruct your
  compiler to treat equality comparisons between floating-point values as
  errors.}.  What you want instead is to check whether the value of the
expression is near a reference.  In order to do this, attach the ``approx''
macro to the ``check'' instruction, giving it an argument stating the reference
value.  Testudo uses ``\texttt{absdiff()}''
(see~\Sref{sec:difference-between-two-values}) to compute the absolute distance
between the two values.  The test check is successful if and only if that
absolute distance is less than a certain tolerance.

\begin{cpplisting}
check(computed_pi)_approx(2.*asin(1.));
\end{cpplisting}

\begin{cpplisting}
CHECK(computed_pi) APPROX(2. * asin(1.));
\end{cpplisting}

The opposite of the ``approx'' macro is the ``not-approx'' macro:
\begin{center}
  \testudopair{\_not\_approx}{NOT\_APPROX}
\end{center}

By default, the default tolerance used for nearness checks is taken from a
variable named ``\texttt{approx\_epsilon}'', but we'll call it
``$\varepsilon$'' hereafter.  This variable is accessible in all tests.  When
it isn't available in a given scope (such as in an auxiliary function used by a
test), it must be created for the nearness checks to compile.

The default value for ``\texttt{approx\_epsilon}'' is ``\texttt{1e-6}'' (one
millionth), but it can be changed and inspected.

Similar to the ``equal'' macro, the expression in the ``approx'' and
``not-approx'' macros is prefixed with the type of the expression in the
``check'' instruction.

\subsubsectiontestudopair{Define a value for $\bm{\varepsilon}$}%
  {define\_approx\_epsilon}{DEFINE\_APPROX\_EPSILON}
\label{sec:define-value-epsilon}

In order to define $\varepsilon$ (in a situation where it isn't available), use
the ``define approx epsilon'' macro with the initial value for $\varepsilon$.

\begin{cpplisting}
define_approx_epsilon(1e-3); // one thousandth
\end{cpplisting}

\begin{cpplisting}
DEFINE_APPROX_EPSILON(1e-3); // one thousandth
\end{cpplisting}

\subsubsectiontestudopair{Set the value of $\bm{\varepsilon}$}%
  {set\_approx\_epsilon}{SET\_APPROX\_EPSILON}
\label{sec:set-value-epsilon}

When $\varepsilon$ is accessible (in all tests, for instance), you can change
its value with the ``set approx epsilon'' macro, giving it the new value.  The
new value will be used for all subsequent nearness checks, until it is changed
again.

\begin{cpplisting}
set_approx_epsilon(1e-3); // one thousandth
\end{cpplisting}

\begin{cpplisting}
SET_APPROX_EPSILON(1e-3); // one thousandth
\end{cpplisting}

\subsubsectiontestudopair{Show the value of $\bm{\varepsilon}$}%
  {show\_approx\_epsilon}{SHOW\_APPROX\_EPSILON}
\label{sec:show-value-epsilon}

You can also show what the value of $\varepsilon$ is in the test report, by
using the ``show approx epsilon'' macro.

\begin{cpplisting}
show_approx_epsilon();
\end{cpplisting}

\begin{cpplisting}
SHOW_APPROX_EPSILON();
\end{cpplisting}

\subsubsectiontestudopair{Set a specific tolerance for nearness}%
  {\_tol}{TOL}
\label{sec:specify-tolerance-nearness}

You can also choose to override the default tolerance value for a specific
check, by attaching the ``tol'' macro with the tolerance value before the
``approx'' macro.

\begin{cpplisting}
check(area)_tol(.1)_approx(3.5); // use one-tenth tolerance just this once
\end{cpplisting}

\begin{cpplisting}
CHECK(area) TOL(.1) APPROX(3.5); // use one-tenth tolerance just this once
\end{cpplisting}


\subsectiontestudopair{Predicate checks}{\_verify}{VERIFY}
\label{sec:predicate-checks}

The checked value can also be tested with a \emph{predicate}.  In Testudo, a
predicate is a function object that accepts one argument and returns a
bool.  A predicate can be constructed using in one of three ways:
\begin{itemize}
\item from a lambda expression: \testudopair{predicate}{PREDICATE}
\begin{cpplisting}
declare(auto is_negative=
        predicate([](int x) { return x<0; }));
\end{cpplisting}

\begin{cpplisting}
DECLARE(auto is_negative =
        PREDICATE([](int x) { return x < 0; }));
\end{cpplisting}

\item from a bool expression:
  \testudopair{predicate\_a}{PREDICATE\_A} (the expression must use the
  parameter name ``\texttt{a}'')
\begin{cpplisting}
declare(auto is_even=predicate_a((a%2)==0));
\end{cpplisting}

\begin{cpplisting}
DECLARE(auto is_even = PREDICATE_A((a % 2) == 0));
\end{cpplisting}

\item from a bool expression with capture:
  \testudopair{predicate\_c\_a}{PREDICATE\_C\_A} (like the previous one, but a
  first parenthesised\footnote{Captures are usually surrounded with square
    brackets, but in this syntax, they must me surrounded by regular brackets.}
  argument gives the list of captures)
\begin{cpplisting}
declare(auto is_multiple_of=
        [](auto n)
          { return predicate_c_a((n), (a%n)==0); });
\end{cpplisting}

\begin{cpplisting}
DECLARE(auto is_multiple_of =
        [](auto n)
          { return PREDICATE_C_A((n), (a % n) == 0); });
\end{cpplisting}
\end{itemize}

Using such predicate objects, the ``check-verify'' syntax checks whether the
checked value verifies the predicate:
\begin{cpplisting}
check(number_of_cards)_verify(is_even);
check(score)_verify(is_multiple_of(5));
\end{cpplisting}

\begin{cpplisting}
CHECK(number_of_cards) VERIFY(is_even);
CHECK(score) VERIFY(is_multiple_of(5));
\end{cpplisting}

Predicates can be combined with the logical operators ``\texttt{not}'',
``\texttt{and}'', and ``\texttt{or}'':
\begin{cpplisting}
check(iterations)
  _verify(not is_negative
          and (is_even or is_multiple_of(5)));
\end{cpplisting}

\begin{cpplisting}
CHECK(iterations)
  VERIFY(not is_negative
         and (is_even or is_multiple_of(5)));
\end{cpplisting}

The ``check-verify'' syntax, when it is the natural means of expression for a
check, is superior to the ``check-true'' syntax because
\begin{itemize}
\item in case of failure, it shows the value of the checked value;
\item it makes it possible to define and reuse concise predicates with good
  names, that improve clarity and raise the level of abstraction of the tests.
\end{itemize}

The opposite of the ``verify'' macro is the ``not-verify'' macro:
\begin{center}
  \testudopair{\_not\_verify}{NOT\_VERIFY}
\end{center}

\subsectiontestudopair{Exception checks}%
  {check\_try \_catch}{CHECK\_TRY \_CATCH}
\label{sec:exception-checks}

Instead of checking the value of an expression, you can also check that
evaluating an expression throws an exception.  This is done with the
``check-try-catch'' instruction, passing it the expression that is expected to
throw.  Testudo will run the expression within a try-block; if an exception
with the expected type (``\texttt{std::exception}'' by default) is thrown, the
exception is reported, and the test step is successful.  If no exception is
thrown, the test step is failed. If an exception with an unexpected type is
thrown, the test step is failed, and an unexpected exception error is reported
(see~\Sref{sec:unexpected-exceptions}).

\begin{cpplisting}
declare(list<int> numbers);
check_try(numbers.front())_catch();
\end{cpplisting}

\begin{cpplisting}
DECLARE(list<int> numbers);
CHECK_TRY(numbers.front()) CATCH();
\end{cpplisting}

The ``check-try-catch'' instructions expects a exception with a type derived
from ``\texttt{std::exception}'' by default.  You can change the expected
exception type by passing it as an argument to the ``catch'' part of the
instruction:
\begin{cpplisting}
declare(my_list<int> numbers);
check_try(numbers.front())_catch(my_list_exception);
\end{cpplisting}

\begin{cpplisting}
DECLARE(my_list<int> numbers);
CHECK_TRY(numbers.front()) CATCH(my_list_exception);
\end{cpplisting}


\section{Adding information to the report}
\label{sec:adding-information-report}

Various pieces of information can be added to the report about the execution of
the test, to help the human reader.

\subsection{Showing values}
\label{sec:showing-values}

You can show the value of an expression in the report.  It doesn't add to the
tally of tests, but it can add clarity about what's going on.

\subsubsectiontestudopair{Show a plain value}%
  {show\_value}{SHOW\_VALUE}
\label{sec:show-plain-value}

The ``show value'' instruction shows the value of its argument inline.

\begin{cpplisting}
show_value(helicopter.remaining_fuel());
\end{cpplisting}

\begin{cpplisting}
SHOW_VALUE(helicopter.remaining_fuel());
\end{cpplisting}

\subsubsectiontestudopair{Show a multiline value}
  {show\_multiline\_value}{SHOW\_MULTILINE\_VALUE}
\label{sec:show-multiline-value}

If the value to show may contain newlines, the format used by the ``show
multiline value'' macro will be clearer: it will be suited for multiline
values, and it will respect the newlines.

\begin{cpplisting}
show_multiline_value(radio.communication_log());
\end{cpplisting}

\begin{cpplisting}
SHOW_MULTILINE_VALUE(radio.communication_log());
\end{cpplisting}

\subsectiontestudopair{Scopes}{in\_scope}{IN\_SCOPE}
\label{sec:scopes}

In some situations, such as when we want to check the effect of the destruction
of an object that's gone out of scope, it can be useful to show where a scope
begins and ends.  This is done by using the ``in-scope'' macro just before the
opening brace of the scope, which writes a message to the report about the new
scope.  You don't have to add anything to the closing brace: Testudo will
automatically write a message when the scope ends.

Most of the time, with short scopes, you don't need to name the scope.  This is
done by using the ``in scope'' macro without any arguments.  If the scope is
longer, it may be clearer to name it, since the scope's begin and end messages
will display its name.  This is done by passing the scope name to the
``in-scope'' macro.

\begin{cpplisting}
declare(LoggedDestruction ld1("1"));
check(LoggedDestruction::n_destructions())_equal(0);
in_scope("outer scope") { // named scope
  declare(LoggedDestruction ld2("2"));
  in_scope() { // unnamed scope
    declare(LoggedDestruction ld3("3"));
  }
  check(LoggedDestruction::n_destructions())_equal(1);
}
check(LoggedDestruction::n_destructions())_equal(2);
\end{cpplisting}

\begin{cpplisting}
DECLARE(LoggedDestruction ld1("1"));
CHECK(LoggedDestruction::n_destructions()) EQUAL(0);
IN_SCOPE("outer scope") // named scope
{
  DECLARE(LoggedDestruction ld2("2"));
  IN_SCOPE() // unnamed scope
  {
    DECLARE(LoggedDestruction ld3("3"));
  }
  CHECK(LoggedDestruction::n_destructions()) EQUAL(1);
}
CHECK(LoggedDestruction::n_destructions()) EQUAL(2);
\end{cpplisting}

\subsectiontestudopair{With-declare scopes}{with\_declare}{WITH\_DECLARE}
\label{sec:with-declare-scopes}

Sometimes, you want to perform a sequence of steps using a temporary value that
you want to (or can) compute only once.  This is achieved by creating a scope
with the ``with-declare'' macro.  It works like the ``in-scope'' macro, but
instead of a name, its argument is the declaration that will be in place in the
macro.  The declaration is identical to what you would give the ``declare''
macro.  You can also use the ``with-declare'' macro with no braces if the scope
contains only one statement.

\begin{cpplisting}
with_declare(auto answer=client.request("get license")) {
  check(answer.valid)_true;
  check(answer.text)_equal("res://punk_license");
}
with_declare(auto answer=client.request("reset"))
  check(answer.valid)_true;
\end{cpplisting}

\begin{cpplisting}
WITH_DECLARE(auto answer=client.request("get license"))
{
  CHECK(answer.valid) TRUE;
  CHECK(answer.text) EQUAL("res://punk_license");
}
WITH_DECLARE(auto answer=client.request("reset"))
  CHECK(answer.valid) TRUE;
\end{cpplisting}

If you need to use the ``with-declare'' macro with several variable
declarations, you can always use a ``structured binding declaration'':
\begin{cpplisting}
with_declare(auto [action, occurrences]=tuple{"sin", 77*7}) {
  check(action)_equal("sin");
  check(occurrences)_equal(539);
}
\end{cpplisting}

\begin{cpplisting}
WITH_DECLARE(auto [action, occurrences]=tuple{"sin", 77*7})
{
  CHECK(action) EQUAL("sin");
  CHECK(occurrences) EQUAL(539);
}
\end{cpplisting}

\section{Identifying steps}
\label{sec:identifying-steps}

You can identify certain steps, to make it easier to follow their evolution.
It's particularly appropriate for checks\footnote{---FIXME---I will add a
  feature to add a section to the full reports and summary reports with the
  results of the identified steps; this will make it possible to make
  id'd-step-only diffs to follow their evolution.---}.  Step \textsc{id}s are
relative to the test they're in, and their full name is prefixed with the full
name of the current test, so they must include only the necessary information
within the test scope.  A step \textsc{id} must be a valid \Cpp{} variable
name.

The ``step id'' instruction prints a tag on the report that applies to the
following step in the test.
\begin{cpplisting}
define_test(medical, switch_on, "switch on after") {
  declare(Tricorder t);
  step_id(init_off); // in the tricorder medical test; no need to mention it
  check(not t.medical.is_on())_true;
}
\end{cpplisting}

\begin{cpplisting}
DEFINE_TEST(medical, switch_on, "switch on after") {
  DECLARE(Tricorder t);
  STEP_ID(init_off); // in the tricorder medical test; no need to mention it
  CHECK(not t.medical.is_on()) TRUE;
}
\end{cpplisting}


\section{Printing fixed text and separations}
\label{sec:printing-text-separations}

You can add fixed messages to the report, to aid the comprehension of the
reader.  They should be considered to play the same rôle as comments is source
code.

\subsectiontestudopair{Print inline text}{print\_text}{PRINT\_TEXT}
\label{sec:print-inline-text}

The ``print text'' instruction displays its argument inline.  The argument must
be a string of any kind.

\begin{cpplisting}
print_text("the speed hasn't been updated yet");
\end{cpplisting}

\begin{cpplisting}
PRINT_TEXT("the speed hasn't been updated yet");
\end{cpplisting}


\subsectiontestudopair{Print multiline text}%
  {print\_multiline\_text}{PRINT\_MULTILINE\_TEXT}
\label{sec:print-multiline-text}

If the message contains newlines, use the ``print multiline text'' instruction
instead: it's suited for multiline text, and respects the newlines.

\begin{cpplisting}
print_multiline_text("the order will be:\n"
                     "  1. insert all elements\n"
                     "  2. sort the container");
\end{cpplisting}

\begin{cpplisting}
PRINT_MULTILINE_TEXT("the order will be:\n"
                     "  1. insert all elements\n"
                     "  2. sort the container");
\end{cpplisting}

\subsectiontestudopair{Print a break}{print\_break}{PRINT\_BREAK}
\label{sec:print-break}

The ``print break'' instruction just prints a break, to show a change of focus
in the test report.

\begin{cpplisting}
print_break();
\end{cpplisting}

\begin{cpplisting}
PRINT_BREAK();
\end{cpplisting}


\section{Fake declarations and actions}
\label{sec:fake-declarations-actions}

Sometimes, you want to record a declaration on an action that won't be carried
out at all, as if it had.  This can be the case, for instance, when there's an
instruction that makes sense for most compilation settings, but there's a
certain combination of compilation options where it doesn't; in that case, for
that compilation, you'll want to record a fake instruction, and then silently
carry out explicitly a replacement instruction, with no test instruction macro,
so that test reports are the same across compilation settings.

\subsectiontestudopair{Fake declaration}{fake\_declare}{FAKE\_DECLARE}
\label{sec:fake-action}

You can report a fake declaration by enclosing an instruction in a
``fake-declare instruction.  The instruction will be written to the report,
exactly as if it had been carried out, except it won't have.
\begin{cpplisting}
#ifdef DEBUGGING
declare(LoggedInt n_cases); // optimised to \texttt{int} in production
#else
fake_declare(LoggedInt n_cases);
int n_cases; // replacement declaration (naked)
#endif
\end{cpplisting}

\begin{cpplisting}
#ifdef DEBUGGING
DECLARE(LoggedInt n_cases); // optimised to \texttt{int} in production
#else
FAKE_DECLARE(LoggedInt n_cases);
int n_cases; // replacement declaration (naked)
#endif
\end{cpplisting}


\subsectiontestudopair{Fake action}{fake\_perform}{FAKE\_PERFORM}
\label{sec:fake-action}

You can report a fake action by enclosing an instruction in a ``fake-perform''
instruction.  The instruction will be written to the report, exactly as if it
had been carried out, except it won't have.
\begin{cpplisting}
#ifdef DEBUGGING
perform(terrible_pointer.report()); // won't work in production
#else
fake_perform(terrible_p.report());
log << "terrible_p reported" << endl; // replacement action (naked)
#endif
\end{cpplisting}

\begin{cpplisting}
#ifdef DEBUGGING
PERFORM(terrible_pointer.report()); // won't work in production
#else
FAKE_PERFORM(terrible_p.report());
log << "terrible_p reported" << endl; // replacement action (naked)
#endif
\end{cpplisting}


\section{Unexpected exceptions}
\label{sec:unexpected-exceptions}

If an unexpected exception (i.e., an exception not in a ``check-try-catch''
instruction; see~\Sref{sec:exception-checks}, or one in a ``check-try-catch''
instruction that isn't caught because it isn't the right type) is thrown in the
course of a test, that particular test ends immediately, a description of the
exception is written to the report, with a conspicuously coloured (where
available) \verb|[ERR-]| flag, and the test is marked as having one error.
Then, the execution of the rest of the tests resumes.  Other tests are not
affected by the exception, and are executed as normal.

Errors aren't the same as failed checks.  They get their own tally.  Errors
aren't an expected situation, even in a failed test that you may be using to do
\textsc{tdd}.  Therefore, test summaries mention the number of errors only
when there is at least one error.  A test that has at least one error isn't
marked with the \verb|[FAIL]| flag, but rather with \verb|[ERR-]|.


\section{Fatal errors}
\label{sec:fatal-errors}

Fatal errors (i.e., errors that cause immediate termination of the executable,
rather than throwing an exception) are something Testudo can't do anything
about.  They will terminate the whole test suite execution.  There's a couple
of things you can do to investigate what's going on.  First, you can run the
tests using a synchronous format like ``\texttt{color\_text}''
(see~\Sref{cha:test-output-formats}), to see where the execution stops (which
test and which test step).  You can then go investigate and fix the error, or
run the tests excluding that particular test to know what the current situation
is, barring the failing test.  You can also run the test with a debugger, but
in that case, be aware that Testudo's macros add management code (classes,
methods, functions, variables, statements\ellipsis{}) to your instructions to
achieve the intended results, and their workings may be confusing, so try to
pay no attention to that man behind the curtain.


\chapter{Test-aware functions}
\label{cha:test-aware-functions}

You may want to perform the same test several times, with only minor
variations, such as a type or a value\footnote{If what changes is a value,
  consider first whether ``with-data'' loops (\Sref{cha:with-data-loops}) fit
  your need.}.  This can be done with \emph{test-aware} functions (or methods,
or classes).  Test-awareness involves:
\begin{itemize}
\item getting an object of type ``\texttt{test\_management\_t}'';
\item making it available as a variable called ``\texttt{test\_management}'' in
  the scope where test macros are used.
\end{itemize}
The ``\texttt{test\_management\_t}'' is always available as
``\texttt{test\_management}'' in a test definition.

Here's an example where we test emptiness of two container-like classes:
\begin{cpplisting}
template <typename Container>
void test_container_emptyness(
    test_management_t test_management,
    Container &container) {
  check(container.empty())_true;
}

class Cauldron { ... };

define_test(container, emptyness_c, "Cauldron emptyness") {
  declare(Cauldron container);
  test_container_emptyness(test_management, container);
}

class Marmite { ... };

define_test(container, emptyness_m, "Marmite emptyness") {
  declare(Marmite container);
  test_container_emptyness(test_management, container);
}
\end{cpplisting}

\begin{cpplisting}
template <typename Container>
void test_container_emptyness(
    test_management_t test_management,
    Container &container)
{
  CHECK(container.empty()) TRUE;
}

class Cauldron { ... };

define_test(container, emptyness_c, "Cauldron emptiness")
{
  DECLARE(Cauldron container);
  test_container_emptyness(test_management, container);
}

class Marmite { ... };

define_test(container, emptyness_m, "Marmite emptiness")
{
  DECLARE(Marmite container);
  test_container_emptyness(test_management, container);
}
\end{cpplisting}


\chaptertestudopair{With-data loops}{with\_data}{WITH\_DATA}
\label{cha:with-data-loops}

You may need to perform the same checks on many values.  This happens, for
instance, if you're checking a certain property holds for all possible values
of a type\footnote{My inner voice calls this feature ``theorem checking''.};
you would implement this by creating a large list of such values, and applying
to them the same test steps.  This can be easily done with the ``with-data''
loop syntax.

This syntax accepts two arguments: the name of the variable that's going to be
tested, and a container with all values to test.  The container can be stored
in advance in a variable, or built inline.  When inline, a valid container can
be specified by a simple braced list of values.  The ``with-data'' macro is
followed by the test to perform on the variable values.  The test can be a
single check instruction, or a brace-enclosed sequence of instructions and
checks.  The report output shows the variable name and the container, followed
by the instructions and checks to be performed (only once), and one fail line
per failed value; if all values pass the tests, an additional line is output
with an \textsc{ok} flag for ``all successful''.

You can chain ``with-data'' macros as you would chain ``for'' loops.  Testudo
is aware of chained ``with-data'' macros and will output parsimonious reports
for them, grouping failed coordinated values into single-line fail reports, and
outputting only one success line in case of success.

Here is an example:
\begin{cpplisting}
declare(auto is_even=predicate_a((a%2)==0));
declare(list<int> even_numbers{2, 4, 8}); // even numbers
with_data(x, even_numbers)
  check(x)_verify(is_even);
with_data(x, even_numbers) {
  declare(int y=x+1);
  check(y)_verify(not is_even);
}
with_data(x, even_numbers)
  with_data(y, {2, 4, 9})
    check(x%2)_equal(y%2); // will fail when \texttt{y==9}
\end{cpplisting}

\begin{cpplisting}
DECLARE(auto is_even=PREDICATE_A((a % 2) == 0));
DECLARE(list<int> even_numbers{ 2, 4, 8 }); // even numbers
WITH_DATA(x, even_numbers)
  CHECK(x) VERIFY(is_even);
WITH_DATA(x, even_numbers)
{
  DECLARE(int y = x + 1);
  CHECK(y) VERIFY(not is_even);
}
WITH_DATA(x, even_numbers)
  WITH_DATA(y, { 2, 4, 9 })
    CHECK(x % 2) EQUAL(y % 2); // will fail when \texttt{y==9}
\end{cpplisting}

\section{How to generate data for with-data loops}
\label{sec:generate-data-with-data-loops}

You can use the function ``\texttt{generate\_data()}'' to generate data for
with-data loops.  The arguments for that function are the number of data to
generate, and a function argument with no arguments that will be called
repeatedly to generate the data.  A~common case is the generation of a large
number of random data for verification of properties of types or algorithms.

Imagine you've coded a \textsc{2d} integer vector class ``\texttt{VectorI2}''
\begin{cpplisting}
class VectorI2 {
public:
  VectorI2(int x, int y);
  int x, y;
};
bool operator==(VectorI2 v, Vector I2w); // equality
string to_text(VectorI2 v); // text representation
VectorI2 operator+(VectorI2 v, VectorI2 w); // sum
\end{cpplisting}
and you want to verify on it the following theorem
\begin{equation}
  \label{eq:1}
  \forall (v, w) \in \texttt{VectorI2}^2, v + w = w + x
\end{equation}
(commutativity of the sum).  You could code a random ``\texttt{VectorI2}''
generator
\begin{cpplisting}
VectorI2 random_vector2i(int max_abs_x, int max_abs_y);
\end{cpplisting}
and use it like this to check the theorem on $100 \times 100$ pairs of random
values with a maximum absolute coordinate value of~$20$:
\begin{cpplisting}
declare(auto generate_20_20=
        []() { return random_vector2i(20, 20); });
with_data(v, generate_data(100, generate_20_20))
  with_data(w, generate_data(100, generate_20_20))
    check(v+w)_equal(w+v);
\end{cpplisting}

\begin{cpplisting}
DECLARE(auto generate_20_20=
        []() { return random_vector2i(20, 20); });
WITH_DATA(v, generate_data(100, generate_20_20))
  WITH_DATA(w, generate_data(100, generate_20_20))
    CHECK(v+w) EQUAL(w+v);
\end{cpplisting}


\chapter{Fixtures}
\label{cha:fixtures}

Test fixtures gather common functionality needed by several tests, most
commonly test setup and test teardown.

\section{Definition}
\label{sec:fixture-definition}

This is how fixtures are implemented in Testudo.  If you want to code a
fixture, you have to code a class that derives from
``\texttt{Fixture}''.  Its constructor must accept an object of type
``\texttt{test\_management\_t}, and pass it out to the constructor of
``\texttt{Fixture}''.  The constructor is the setup procedure; the
destructor, if you code it, is the teardown procedure.

Here's an example:
\begin{cpplisting}
struct OutATimeFixture : Fixture {
  OutATimeFixture(test_management_t test_management)
    : Fixture(test_management)
    { perform(d=new Delorean); }
  ~OutATimeFixture()
    { perform(delete d); }
  Delorean *d; // dumb pointer, just so we can show a teardown procedure
};
\end{cpplisting}

\begin{cpplisting}
struct OutATimeFixture : Fixture
{
  OutATimeFixture(test_management_t test_management)
    : Fixture(test_management)
  {
    PERFORM(d=new Delorean);
  }
  ~OutATimeFixture()
  {
    PERFORM(delete d);
  }
  Delorean *d; // dumb pointer, just so we can show a teardown procedure
};
\end{cpplisting}

\section{Usage}
\label{sec:fixture-usage}

In order to have a test use a fixture, you have to add the ``with-fixture''
macro or the ``visible-fixture'' macro just after the title in the definition
(before other arguments if any); this works both with non-top and with top
tests.  Like this:
\begin{cpplisting}
define_test(delorean,
            engine_starts_off, "engine is off at start",
            with_fixture(OutATimeFixture)) // with-fixture
{
  check(not d->engine.is_running())_true;
}

define_test(delorean,
            no_pu_at_start, "there's no Plutonium initially",
            visible_fixture(OutATimeFixture)) // visible-fixture
{
  check(d->pu())_approx(0.);
}
\end{cpplisting}

\begin{cpplisting}
DEFINE_TEST(delorean,
            engine_starts_off, "engine is off at start",
            WITH_FIXTURE(OutATimeFixture)) // with-fixture
{
  CHECK(not d->engine.is_running()) TRUE;
}

DEFINE_TEST(delorean,
            no_pu_at_start, "there's no Plutonium initially",
            VISIBLE_FIXTURE(OutATimeFixture)) // visible-fixture
{
  CHECK(d->pu()) APPROX(0.);
}
\end{cpplisting}

If you use the ``with-fixture'' macro, Testudo macros used in the fixture
implementation, whether in the constructor, the destructor, or any other
method, aren't logged to the test report.  If you use the ``visible-fixture''
instead, Testudo macros in the fixture implementation are logged as usual, and
the end of the constructor and the beginning of the destructor are logged.

You can code other methods in a fixture, and you can call them from test
functions.  In fact, the test function ends up being one of the methods of the
fixture, so that's why and how.

\section{Fixture members and their initialisation}
\label{sec:fixture-members-and-initialisation}

You should declare fixture attributes (member variables) and their
initialisation with Testudo macros, so that they're logged if the fixture is
used with the ``visible-fixture'' macro.  This is done by using the
``fixture-member'' macro for attribute declarations\footnote{The
  ``fixture-member'' macro has a limitation: there can only be one
  ``fixture-member'' macro usage per source code line.  This isn't a big deal,
  because that's how you'll use it anyway, unless you're trying to have a badly
  packed source code, but i'm telling you just in case.}, and the
``fixture-init'' macro for attribute initialisations.  The ``fixture-member''
macro encloses an attribute declaration of any kind: it can contain several
declarations, or default values.  The ``fixture-init'' macro accepts as its
first argument the name of the attribute, and as its second argument its
initial value.  Here's an example of usage:
\begin{cpplisting}
struct NumbersFixture : Fixture {
  NumbersFixture(test_management_t test_management)
    : Fixture(test_management),
      fixture_init(x, 1.), fixture_init(z, 3.14) { }
  fixture_member(double x);
  fixture_member(double y=-2.5, z);
};
\end{cpplisting}

\begin{cpplisting}
struct NumbersFixture : Fixture
{
  NumbersFixture(test_management_t test_management)
    : Fixture(test_management),
      FIXTURE_INIT(x, 1.),
      FIXTURE_INIT(z, 3.14) { }
  FIXTURE_MEMBER(double x);
  FIXTURE_MEMBER(double y=-2.5, z);
};
\end{cpplisting}

Other actions in the fixture implementation are enclosed in Testudo macros in
the usual way (with the ``declare'' macro, the ``perform'' macro, and so on).


\chapter{Mock objects}
\label{cha:mock-objects}

Testudo supports mock objects through its ``Mock Turtle'' module.  Include
header file ``\texttt{mock\_turtle.h}'' to use it.

You can build your mock objects in any way you want: with simple method
overriding, with virtual method overriding, or with no overriding and no
derivation.  The mock method macros define the methods precisely in accordance
with your specification, so it's up to you to decide.

Here's Mock Turtle's approach to mock testing:
\begin{itemize}
\item define mock classes using the mock-method macros ``mock-method'' and
  ``wrap-method'' (\Sref{sec:mock-method-macros}); this adds scheduling and
  logging machinery to the classes automatically;
\item if necessary, set up across-method ledgers
  (\Sref{sec:check-mock-method-ledgers});
\item in a test definition, create instances of the mock classes;
\item if necessary, set up across-instances ledgers
  (\Sref{sec:check-mock-method-ledgers-across-mock-objects});
\item schedule mock object behaviour as needed
  (\Sref{sec:schedule-mock-method});
\item use mock objects as if they were the real thing;
\item check logged behaviour against expected behaviour by accessing call logs
  and ledgers (\Sref{sec:check-mock-method-logs}, \Sref{sec:scan-ledger}).
\end{itemize}

\section{Mock-method macros}
\label{sec:mock-method-macros}

When you need to test a functionality, you may want to use mock implementations
for some of the parts that are needed but aren't the focus of the test.
Typically, these parts are functionality that is external to your code, or
costly to run, or slow, or having dependencies on unavailable resources.  The
usual way to achieve this is in \Cpp{} by replacing the affected parts by
objects that have the same interface as the problematic ones, but ad-hoc
implementations tailored to the test.

How you implement a mock class depends on how the mocked class is defined, and
you use it.  It's usually a matter of replicating the interface or deriving
from the mock class and overriding its virtual methods.  The first approach
would be appropriate, e.g., if the class is a template argument to function or
another class.  The second one is good for polymorphic designs.

Testudo mock-method macros will help you deal with the most usual cases for
mock method implementations.  There are two available macros to mock a method:
\begin{itemize}
\item the ``mock-method'' macro, that creates a dumb implementation, where
  return values for the method can be pre-scheduled, and with automatic
  logging of arguments and return value;
\item the ``wrap-method'' macro, that allows you to provide a specific
  implementation, but still adds to it automatically the logging of arguments
  and return value.
\end{itemize}
Both macros allow you to specify how the method mocks its original version,
whether by merely defining it, or by overriding a virtual one in the base
class.

Before you use these macros, you must define the mock class.  The only
requirement is that it publicly must derive from
``\texttt{MockClass<>}''.  If your mock class derives from a base
class (say ``\texttt{Base}''), you can make it derive from
``\texttt{MockClass<Base>}'' instead, which derives from both
``\texttt{Base}'' and ``\texttt{MockClass<>}'', and inherits
``\texttt{Base}'' constructors.  Here are a couple of examples, one for a mock
class deriving from a virtual class, and one for a non-derived mock class:
\begin{cpplisting}
class KettleBase {
public:
  virtual ~KettleBase()=default;
  virtual void fill(float volume)=0;
  virtual float temperature() const=0;
};

class KettleMock
  : public MockClass<KettleBase> {
public:
  // method mocks and wraps overriding base methods\ellipsis{}
};

class ContainerMock
  : public MockClass<> {
public:
  // method mocks and wraps defining a cointainer interface\ellipsis{}
};
\end{cpplisting}

\subsectiontestudopair{Mocking a method}{mock\_method}{MOCK\_METHOD}
\label{sec:mocking-method}

In order to mock a method, use the ``mock-method'' macro where you would
normally define the method, followed by a semicolon.  This will automatically
create an implementation for the method that logs all calls (argument values,
return value, and order across methods and objects) to it
(\Sref{sec:check-mock-method-logs}, \Sref{sec:check-mock-method-ledgers}), and
allows you to set up a schedule for return values
(\Sref{sec:schedule-mock-method}).

The arguments to the ``mock-method'' macro are, in order (see below for an
explanation of the usage of the word \emph{parenthesised}),
\begin{itemize}
\item the \emph{parenthesised} return type;
\item the name of the method (or a its name and an alternative name; see
  below);
\item a \emph{parenthesised} list of \emph{parenthesised} arguments;
\item optional method specifiers like ``\texttt{const}'',
  ``\texttt{override}'', or ``\texttt{final}'', separated by spaces; leave this
  argument out if you don't need it.
\end{itemize}

The return type macro argument is \emph{parenthesised}, which means it must be
enclosed between ``\texttt{(}'' and ``\texttt{)}''.  This is done so the macros
aren't confused by templated types that may contain commas in
them\footnote{I've seen Google Mock solves this issue in a similar way, but the
  parentheses are optional, meaning that if your type doesn't contain any
  macro-fooling comma, you can leave them out.  I prefer to make
  parenthesisation mandatory, because once you get used to it, you won't be
  left wondering why your macro doesn't work if you forget to use it for a type
  that requires it.}, like ``\texttt{map<int, float>}''.  If the return type is
``\texttt{void}'', you still have to write it in parenthesis.  So, examples of
return type arguments to the ``mock-method'' macro are
\begin{itemize}
\item \texttt{(int)}
\item \texttt{(void)}
\item \texttt{(map<pair<int, string>, float>)}
\end{itemize}

Similarly, the list-of-arguments macro argument is a \emph{parenthesised} list
of \emph{parenthesised} arguments.  This means that, for the same reasons as
for the return type argument, not only is the list enclosed in parentheses, but
each argument is also enclosed in parentheses\footnote{I'm thorry thith hath
  become tho lithpy; there'th no other way with theepluthpluth macroth.}.  For
each argument, you have to specify its type, and can optionally include in the
parentheses for the type an argument name.  The argument name is discarded by
the ``mock-method'' macro, but will be very important when wrapping (rather
than mocking) methods with the ``wrap-method'' macro
(see~\Sref{sec:wrapping-method}).  Here are some examples of list-or-arguments
arguments to the ``mock-method'':
\begin{itemize}
\item \texttt{()}
\item \texttt{((int))}
\item \texttt{((int), (unsigned char))}
\item \texttt{((int quantity))}
\item \texttt{((string name), (int))}
\item \texttt{((map<int, float> const \&), (int id))}
\end{itemize}

The name-of-method macro argument is simply the name of the method, with no
parentheses.  Its associated scheduler and logger objects will be named after
the method, and this will cause name clashes if you have overloaded methods in
the same class.  In that case, you can give your method an alternative name,
meaning that, although its real name will be used for the method definition,
everything else (the scheduler, the logger, and references to it in ledgers)
will use the alternative name.  To specify an alternative name, just replace
the name-of-method argument with the name of the method and the alternative
name separated by a comma, in parentheses.  So, for instance, the following
wouldn't work
\begin{cpplisting}
class ImageMock
  : public MockClass<> {
public:
  mock_method((void), set, ((float)));
  mock_method((voud), set, ((int)));
};
\end{cpplisting}
so we'll have to identify one of the ``\texttt{set()}'' methods (or both) with
an alternative name:
\begin{cpplisting}
class ImageMock
  : public MockClass<> {
public:
  mock_method((void), set, ((float)));
  mock_method((voud), (set, set_int), ((int)));
};
\end{cpplisting}

Finally, the method-specifiers macro argument consists of what you'd put after
the method signature if you were defining it directly.  Things like
``\texttt{const}'' (for method constness), ``\texttt{override}'', or
``\texttt{final}'' go there, separated by spaces.  If there's nothing to
specify here, just leave out the macro argument (no need to add the comma after
the previous argument).  Here's an example with const and non-const overrides:
\begin{cpplisting}
class KettleBase {
public:
  virtual ~KettleBase()=default;
  virtual void fill(float volume)=0;
  virtual float temperature() const=0;
};

class KettleMock
  : public MockClass<KettleBase>> {
public:
  mock_method((void), fill, ((float volume)), override);
  mock_method((float, temperature, (), const override);
};
\end{cpplisting}


\subsectiontestudopair{Wrapping a method}{wrap\_method}{WRAP\_METHOD}
\label{sec:wrapping-method}

Wrapping a method is similar to mocking a method, but instead of having the
method automatically generated, and its return values scheduled, you get to
specify exactly what the method does and returns.

In order to wrap a method, use the ``wrap-method'' macro in the same way that
you'd use the ``macro-method'', but instead of adding a semicolon after it,
write your method implementation in braces.  The ``wrap-method'' is essentially
taking the place of the signature of your method.  You still have to add
``\texttt{const}'' before the method implementation if appropriate (but not
``\texttt{override}'' or ``\texttt{final}''); this will amount, in most cases
where you have ``\texttt{const}'' in the macro method-specifier argument, to
repeat it just after the macro.

What the ``wrap-method'' macro affords you compared to writing your own method
is automatic log and ledger handling (\Sref{sec:check-mock-method-logs},
\Sref{sec:check-mock-method-ledgers}), which is identical to that generated by
the ``mock-method'' macro.  Scheduling is not added to a wrapped macro, since
you'll be specifying what is returned.

Here's an example with wrapped methods:
\begin{cpplisting}
class Tally {
public:
  virtual ~Tally()=default;
  virtual void add_counter(int delta)=0;
  virtual int total() const=0;
};

class TallyMock
  : public MockClass<Tally> {
public:
  int counter=0;
  wrap_method((void), add_counter, ((int delta))) {
    counter+=delta;
  }
  wrap_method((int), total, (), const) const { // \texttt{const} twice
    return counter;
  }
};
\end{cpplisting}


\section{How to schedule mock-method behaviour}
\label{sec:schedule-mock-method}

By default, a mock-method generated by the ``mock-method'' macro always returns
the default value of its default type.  You can change this by setting
different default value or by scheduling a set of values to return in sequence.
You can also set it to return the result of evaluating a function with no
arguments (given, for instance, as a lambda expression).  The general behaviour
of the scheduler when asked for a return value is this:
\begin{itemize}
\item while the queue of scheduled return values isn't empty, return the next
  value, and pop it from the queue;
\item if the queue of scheduled return values is empty, return the default
  return value, or the result of evaluating the default function.
\end{itemize}

\subsectiontestudopair{Set the default return value}%
  {set\_ret\_default}{SET\_RET\_DEFAULT}

You can change the default return value in one of two ways:
\begin{itemize}
\item by assigning a value or function to the ``mock-method'' macro expression
  in the mock class definition:
\begin{cpplisting}
class SoupMock
  : public MockClass<Soup> {
public:
  ...
  // by default, return \texttt{true}:
  mock_method((bool), is_tasty, (), const override)=true;
  ...
};
\end{cpplisting}
\item by using the ``set-ret-default'' macro as a method call on a mock object:
\begin{cpplisting}
define_test(mock_turtle, victorian, "Victorian recipe") {
  declare(auto soup_mock=make_shared<SoupMock>());
  declare(bool is_tasty_now=true);
  perform(soup_mock->set_ret_default(
            is_tasty,
            [&is_tasty_now]() { return is_tasty_now; });
  ...
}
\end{cpplisting}
\end{itemize}

\subsectiontestudopair{Schedule return values or exceptions}%
  {schedule\_ret}{SCHEDULE\_RET}

In order to schedule a sequence of return values for a method, you must use the
``schedule-ret'' macro as a method call on a mock object, giving it first the
name of the method you want to schedule for, and then any number of return
values to use in sequence:
\begin{cpplisting}
class SoupMock
  : public MockClass<Soup> {
public:
  ...
  mock_method((int), (temperature, temp), (), const final);
  ...
};
...
define_test(..., ..., "...") {
  declare(auto soup_mock=make_shared<SoupMock>());
  // return a sequence of temperatures on subsequent calls:
  perform(soup_mock->schedule_ret(temp,
                                  20, 40, 60, 80, 100));
  ...
}
\end{cpplisting}

You can also set the default value or any of the scheduled return values to
throw an exception, rather than returning a value.  This is achieved by
replacing a return value in the ``schedule-ret'' macro with a call to the
function ``\texttt{throw\_exception()}'', giving it the exception to throw:
\begin{cpplisting}
class MockNamable
  : public MockClass<> {
public:
  mock_method((void), create, ());
  mock_method((bool), set_name_is_good, ((string)));
};
...
define_test(..., ..., "...") {
  declare(MockNamable namable);
  // return \texttt{true} for the first call, then throw an exception for the %
     second call:
  perform(
    namable.schedule_ret(set_name_is_good,
      true,
      throw_exception(runtime_error("already named"))));
  ...
}
\end{cpplisting}

If the return type of the method is \texttt{void}, you can use the special
value ``\texttt{void\_v}'' to represent one successful return.  This is
necessary when you want to schedule an exception after a number of uneventful
returns:
\begin{cpplisting}
define_test(..., ..., "...") {
  declare(MockNamable namable);
  // return normally from the first call, then throw an exception for the %
     second call:
  perform(
    namable.schedule_ret(create,
      void_v,
      throw_exception(runtime_error("already created"))));
  ...
}

\end{cpplisting}

\section{How to check mock-method logs}
\label{sec:check-mock-method-logs}

Each mock method (mocked or wrapped) keeps a log of calls to it, with arguments
and return values.  After you've run code that uses your mock objects, you can
perform checks on the logs, with the usual Testudo syntax.

\subsectiontestudopair{Logged arguments}{logged\_args}{LOGGED\_ARGS}

``Invoking'' the ``logged-args'' macro on a mock object will return a vector of
tuples containing the args for all calls to a mock method.  The syntax for the
call follows the syntax for a regular method, and has as its argument the name
(or alternative name) of a mock method.  The vector contains a tuple for each
call, and each tuple contains all the arguments of the call.  So, for instance,
in the following example, we're checking that the ``\texttt{add\_ingr}'' method
was called five times, and we're checking the specific arguments for all calls:
\begin{cpplisting}
declare(auto soup_mock=make_shared<SoupMock>());
...
// five calls, with specific arguments
check(soup_mock->logged_args(add_ingr))
  _equal({{"calf brains", 4},
          {"pork liver", 3},
          {"water", 1},
          {"water", 1},
          {"water", 1}});
\end{cpplisting}

Since the value returned by the ``logged-args'' is a plain \textsc{stl} vector,
you can use it in any vector-like way to check results.  You can, for instance:
\begin{itemize}
\item check its size (although a better way is to use the ``log-size'' macro;
  see below);
\item check a specific call by its number:
\begin{cpplisting}
// check \emph{third} call
check(soup_mock->logged_args(add_ingr)[2])
  _equal({"water", 1});
\end{cpplisting}
\item check a specific argument of a specific call:
\begin{cpplisting}
// check \emph{first} argument of third call:
check(get<0>(soup_mock->logged_args(add_ingr)[2]))
  _equal("water");
\end{cpplisting}
\item or more complex things like checking totals of numerical arguments.
\end{itemize}

\subsectiontestudopair{Logged return values}{logged\_ret}{LOGGED\_RET}

Similarly, the ``logged-ret'' macro returns a vector of tuples containing the
return values for all calls to a mock method\footnote{These are tuples rather
  than naked return values in order to accommodate methods that return
  \texttt{void}, which have empty tuples.}.
\begin{cpplisting}
declare(auto soup_mock=make_shared<SoupMock>());
...
// a single call, that returned \texttt{true}
check(soup_mock->logged_ret(is_tasty))_equal({{true}});
\end{cpplisting}

\subsectiontestudopair{Logged arguments and return values}%
  {logged\_ret\_args}{LOGGED\_RET\_ARGS}

The ``logged-ret-args'' macro combines the ``logged-ret'' and ``logged-args''
macros: it returns a vector of pairs, where each pair contains a tuple with the
return value and a tuple with the arguments of a call.
\begin{cpplisting}
declare(auto soup_mock=make_shared<SoupMock>());
...
// five calls, with specific arguments and return values
check(soup_mock->logged_ret_args(add_ingr))
  _equal({{{4}, {"calf brains", 4}},
          {{7}, {"pork liver", 3}},
          {{8}, {"water", 1}},
          {{9}, {"water", 1}},
          {{10}, {"water", 1}}});
\end{cpplisting}

\subsectiontestudopair{Number of calls}{log\_size}{LOG\_SIZE}

Finally, the ``log-size'' macro returns the number of calls to a mock method:
\begin{cpplisting}
declare(auto soup_mock=make_shared<SoupMock>());
...
// a single call
check(soup_mock->log_size(is_tasty))_equal(1);
\end{cpplisting}

Checks with mock-method logs lend themselves to ``with-declare'' scopes
(\Sref{sec:with-declare-scopes}), where the declaration is for instance the
result of a ``logged-ret-args'' macro, and the contents are checks on that
value.

\subsection{Utilities for log checking}
\label{sec:utilities-log-checking}

The following bool-returning functions can be helpful when checking things like
``this method has always been called with the argument $9$'', or ``all values
returned by this method have been different'':
\begin{itemize}
\item ``\texttt{is\_always(c, a)}'' checks whether all elements of container
  ``\texttt{c}'' are ``\texttt{a}'';
\item ``\texttt{is\_never(c, a)}'' checks whether none of the elements of
  container ``\texttt{c}'' are~``\texttt{a}'';
\item ``\texttt{is\_constant(c)}'' checks whether all the elemennts of
  container ``\texttt{c}'' are the same;
\item ``\texttt{all\_different(c)}'' checks whether all the elements of
  container ``\texttt{c}'' are different.
\end{itemize}

\section{How to check mock-method ledgers}
\label{sec:check-mock-method-ledgers}

In addition to per-mock-method logs (\Sref{sec:check-mock-method-logs}), Mock
Turtle keeps track of the order in which different methods are invoked.  This
tracking is managed by the class ``\texttt{MockClass<>}'' (the one
mock classes must derive from).

\subsectiontestudopair{Checks across mock objects}%
  {call\_ledger\_report\_to}{CALL\_LEDGER\_REPORT\_TO}
\label{sec:check-mock-method-ledgers-across-mock-objects}

You can even keep track of the order in which different methods are invoked
\emph{on different mock objects}, by having mock objects report to a
stand-alone ``\texttt{CallLedger}''
object\footnote{``\texttt{CallLedger}'' is just an alias for
  ``\texttt{MockClass<>}''; this naming reflects better its usage as a
  general call ledger.}.
This is achieved by using the ``call-ledger-report-to'' macro, with a first
argument representing the mock object (by a reference or a pointer), and a
second argument which is a pointer to the stand-alone ``\texttt{CallLedger}''
object.  For purposes of logging, this ``\texttt{CallLedger}'' object will
identify the mock object by the first argument to the ``call-ledger-report-to''
macro.

You will only need a separate ``\texttt{CallLedger}'' if you want to
track calls across several objects.  If you're only interested in tracking
calls across several methods with the same object, you can do it by using the
mock object itself as the call ledger.

Here's an example of cross-object call ledger setup:
\begin{cpplisting}
declare(CallLedger cl);
declare(MockLevel lev1(12));
perform(call_ledger_report_to(lev1, &cl)); // identified as ``\texttt{lev1}''
declare(auto lev2=shared_ptr<MockLevel>(47));
perform(call_ledger_report_to(lev2, &cl)); // identified as ``\texttt{lev2}''
\end{cpplisting}

\subsection[Scanning the ledger]%
  {Scanning the ledger:
    \testudopair{get\_call}{GET\_CALL} and
    \testudopair{pop\_call}{POP\_CALL}}
\label{sec:scan-ledger}

After you've run code that uses your mock objects, you can check the call
ledgers.  Since a ledger logs calls to methods with different signatures, you
can't access a ledger in one call.  You have to use a kind of iterator instead,
that we'll call the \emph{call ledger iterator}.  You obtain the call ledger
iterator by passing the call ledger to the ``\texttt{iterate()}''
function.  Initially, the iterator points to the first ledger entry.  This is
what you can do with a call ledger ``\texttt{it}'':
\begin{itemize}
\item increment it, with ``\texttt{it.next()}'';
\item check if it's pointing past the end of the ledger, with
  ``\texttt{it.done()}'';
\item check if it's \emph{not} pointing past the end, by converting it to bool;
\item reset it to point to the first ledger entry, with
  ``\texttt{it.reset()}'';
\item get the name of the mock object of the call it points to, with
  ``\texttt{it.mock\_name()}'';
\item get the name of the method of the call it points to, with
  ``\texttt{it.method\_name()}'';
\item get an object containing a tuple with the return value and a tuple with
  the arguments of the call it points to; this is called a \emph{call record};
  you must know what the mock object and the method were for the call, and the
  operation consists of ``invoking'' the ``get-call'' macro on the iterator,
  passing it a reference to the expected mock object, and the name (or
  alternative name) of the expected method; if the expected mock object or the
  method are not the actual ones, the returned object is \emph{invalid}, and
  all checks performed on it will fail; here's an example of usage of the
  ``get-call'' macro:
\begin{cpplisting}
with_declare(auto call=it.get_call(*soup_mock, add_ingr))
  check(call)_equal({7}, {"water", 1});
\end{cpplisting}
\item \emph{pop} the call record it points to, by using the ``pop-call'' macro
  on the iterator, rather than the ``get-call'' macro; these macros have the
  same arguments and return the same value, but ``pop-call'' automatically
  increments the iterator \emph{if the returned call record is valid:}
\begin{cpplisting}
with_declare(auto call=it.pop_call(*soup_mock, add_ingr))
  check(call)_equal({7}, {"water", 1});
\end{cpplisting}
\end{itemize}

You can perform the following operations on a call record ``\texttt{cr}'':
\begin{itemize}
\item get the return value (if not \texttt{void}), with ``\texttt{cr.ret()}'';
\item get a tuple with the arguments, with ``\texttt{cr.args()}'';
\item get the method name, with ``\texttt{cr.method\_name}'';
\item get the validity of the call record, with ``\texttt{is\_valid()}''.
\end{itemize}

You can also get a human-readable string listing of the recorded calls for a
call ledger ``\texttt{cl}'', with ``\texttt{print\_calls(cl.calls())}''; each
line shows the names of the mock object and mock method, and a number stating
the zero-based order the call has on the particular mock-method log; you can
print this string with
``\texttt{show\_multiline\_value(print\_calls(cl.calls()))}''.  This can be
  useful when designing or debugging a test.

Similarly to mock-method logs, checks with mock-method ledgers lend themselves
to ``with-declare'' scopes (\Sref{sec:with-declare-scopes}).

Here's an example with mock-method ledgers:
\begin{cpplisting}
declare(auto soup_mock=make_shared<SoupMock>());
...
with_declare(auto it=iterate(soup_mock)) {
  with_declare(auto call=it.pop_call(*soup_mock, add_ingr)) {
    check(call.ret())_equal(4);
    check(call.args())_equal("calf brains", 4);
  }
  ...
  with_declare(auto call=it.pop_call(*soup_mock, temp))
    check(call.ret())_equal(20);
  ...
  with_declare(auto call=it.pop_call(*soup_mock, is_tasty))
    check(call.ret())_true;
  // check it was the last call:
  check(it.done())_true;
}
\end{cpplisting}

Here's an example involving the ``call-ledger-report-to'' macro:
\begin{cpplisting}
declare(CallLedger cl);
declare(MockLevel lev1(12));
perform(call_ledger_report_to(lev1, &cl));
declare(MockLevel lev2(47));
perform(call_ledger_report_to(lev2, &cl));
perform(equalize(lev1, lev2)); // this is the function we're checking
check(lev1.readout())_equal(52);
check(lev2.readout())_equal(52);
declare(auto it=iterate(cl));
// fast forward to the first invocation to ``\texttt{large\_up()}'':
perform(while (it.method_name() not_eq "large_up")
          it.next());
check(it.mock_name())_equal("lev1");
check(it.method_name())_equal("large_up");
perform(it.next());
check(it.mock_name())_equal("lev1");
check(it.method_name())_equal("readout");
\end{cpplisting}


\chapter{Testudo support for \textsc{stl} containers}
\label{cha:testudo-support-stl-types}

If you're going to use \textsc{stl} containers as subjects for your tests,
meaning you're going to show their value, or use it for checks, just include
the ``\texttt{testudo\_ext.h}'' header:
\begin{cpplisting}
#include "testudo_ext.h"
\end{cpplisting}

This will make \textsc{stl} containers printable by Testudo.  Additionally,
although \textsc{stl} containers can be compared with the standard
``\texttt{operator==()}'' operator, so there's nothing to add in that regard,
``\texttt{testudo\_ext.h}'' adds the following two features
\begin{itemize}
\item an \textsc{stl} container will be considered valid
  (\Sref{sec:checked-expression}) if and only if all its elements are;
\item ``approx'' checks (\Sref{sec:check-expression-near-reference}) will use
  the Manhattan distance on the container elements.
\end{itemize}

Bottom line: if you include ``\texttt{testudo\_ext.h}'', Testudo will work well
on \textsc{stl} containers.


\chapter{Adding Testudo support for your types}
\label{cha:adding-testudo-support-your-types}

A type needs four features in order to be fully Testudo-supported:
\begin{itemize}
\item it \emph{may} support the notion of validity; any check done on an
  invalid value is failed, irrespective of the value or the precise check made
  on it (\Sref{sec:checked-expression}); by default, all values of a type are
  considered valid unless you decide to code validity for the type, so you
  often won't need to deal with validity at all;
\item it \emph{must} have a textual representation; this is used when you show
  a value with the ``show-value'' macro (\Sref{sec:show-plain-value}) or with
  the ``show-multiline-value'' macro (\Sref{sec:show-multiline-value}), but
  also when the value is shown for a failed check;
\item it \emph{can} support testing for equality, if you need it for your
  tests, in particular, if you use the ``equal'' macro
  (\Sref{sec:check-expression-equal-reference});
\item it \emph{can} support the notion of ``absolute difference'', if you need
  it for your tests, in particular, if you use the ``approx'' macro
  (\Sref{sec:check-expression-near-reference}).
\end{itemize}

The implementation of each one of these features for your types is described in
the following sections.  You don't need to include any style
(\Sref{cha:test-definition-test-instruction-styles}) to define them, or the
whole Testudo set of functionality.  It's enough if you include the
``\texttt{testudo\_base.h}'' header (and if your definitions don't use the
basic implementations in Testudo, not even that will be needed):
\begin{cpplisting}
#include "testudo_base.h"
\end{cpplisting}

In general, when you customize Testudo support for your type, you either code a
general function for your type, like ``\texttt{operator==()}'' or redirection
to output stream, or define a Testudo-specific function in the same namespace
as your type.  In the latter case, the function name will end with
``\texttt{\_testudo}'' (see each section for the exact name).  If you need to
use any of those Testudo-specific functions (for example, when coding the
function for your type, the definition may use the same function for an
attribute contained within your type), you should use the equivalent function
without the ``\texttt{\_testudo}'', and in the ``\texttt{testudo}'' namespace.

So, for instance, if you're defining validity for type
``\texttt{my\_space::MyType<T>}'', you have to define
\begin{cpplisting}
namespace my_space {
  template <typename T>
  bool is_valid_testudo(MyType<T> ct &mt);
}
\end{cpplisting}
but if the definition depends on the validity of a contained attribute with
type ``\texttt{list<T>}'', then you'll have to use
``\texttt{testudo::is\_valid()}'':
\begin{cpplisting}
namespace my_space {
  template <typename T>
  bool is_valid_testudo(MyType<T> ct &mt) {
    return testudo::is_valid(mt.list_of_elements);
  }
}
\end{cpplisting}


\section{Validity}
\label{sec:validity}

All values are considered valid by default by Testudo
(\Sref{sec:checked-expression}).  If you have a type that may have invalid
values (i.e., values that always yield failed Testudo checks), you have code a
``\texttt{bool is\_valid()}'' function in the type's namespace, that accepts as
its sole argument an object of the type:
\begin{cpplisting}
namespace my_space {
  class MyVector {
  public:
    ...
  };
  bool is_valid(MyVector const &mv) { ... }
}
\end{cpplisting}

If you want to refer to the validity of a value ``\texttt{v}'' of another type
contained in your type, use the expression ``\texttt{testudo::is\_valid(v)}''.

\section{Textual representation}
\label{sec:textual-representation}

In order to tell Testudo how to produce a text representation for a value of
your type, you can either
\begin{itemize}
\item code the ``redirection to output stream'' operator for your type:
\begin{cpplisting}
namespace my_space {
  class MyVector {
  public:
    double x, y;
    ...
  };
  ostream &operator<<(ostream &os, MyVector const &mv) {
    return os << "(" << mv.x << " " << mv.y << ")";
  }
}
\end{cpplisting}
\item or code a ``\texttt{to\_text\_testudo()}'' function in the type's
  namespace, that accepts as its sole argument an object of the type, and
  returns a string that represents it:
\begin{cpplisting}
namespace my_space {
  class MyVector {
  public:
    double x, y;
    ...
  };
  string to_text_testudo(MyVector const &mv) {
    return "("+to_string(mv.x)+" "+to_string(mv.y)+")";
  }
}
\end{cpplisting}
\end{itemize}

If you want to use the textual representation of a value ``\texttt{v}'' of
another type contained in your type, use the expression
``\texttt{testudo::to\_text\_testudo(v)}''.

\section{Equality}
\label{sec:equality}

Checks for equality between values
(\Sref{sec:check-expression-equal-reference}) are done by simply using the
``\texttt{==}'' operator on the values.  So you just have to code the
appropriate ``\texttt{operator==()}'' for your type to be supported by Testudo
checks for equality:
\begin{cpplisting}
namespace my_space {
  template <typename T>
  class MyPair {
  public:
    ...
    T first, second;
  };
  template <typename T>
  bool operator==(MyPair<T> const &mp1,
                  MyPair<T> const &mp2) {
    // see below for ``\texttt{testudo::are\_equal()}''
    return (testudo::are_equal(mp1.first, mp2.first)
             and testudo::are_equal(mp1.second, mp2.second));
  }
}
\end{cpplisting}

Similarly to the other cases, you can also choose to define the
``\texttt{are\_equal\_testudo()}'' function for your type, if you prefer
Testudo to use a different implementation for equality, and you should use
``\texttt{testudo::are\_equal()}'' to test for equality of other values:
\begin{cpplisting}
namespace my_space {
  template <typename T>
  class MyPair { ... };
  template <typename T>
  bool are_equal_testudo(MyPair<T> const &mp1,
                         MyPair<T> const &mp2) {
    return (testudo::are_equal(mp1.first, mp2.first)
             and testudo::are_equal(mp1.second, mp2.second));
  }
}
\end{cpplisting}

\section{Difference between two values}
\label{sec:difference-between-two-values}

Checks for nearness between values (\Sref{sec:check-expression-near-reference})
are done by checking if the absolute difference between the values is below the
tolerance.  For simple scalar types like \texttt{float} and \texttt{double},
this absolute difference is simple the absolute value of the difference, but
for other types that you want to use ``approx'' checks on, you have to define
exactly how it's computed.  This is done by defining a
``\texttt{absdiff\_testudo()}'' function in the type's namespace, that accepts
the two values to compare, and returns the absolute difference as a
\texttt{double} value.
\begin{cpplisting}
class MyVector {
public:
  double x, y;
  ...
};
double absdiff_testudo(MyVector const &mv1,
                       MyVector const &mv2) {
  double dx=mv1.x-mv2.y;
  double dy=mv1.y-mv2.y;
  return sqrt(dx*dx+dy*dy);
}
\end{cpplisting}

The absolute difference need not be exactly the norm of the difference.  Any
function that is zero for identical values and grows for values that are more
and more apart, while giving an order of magnitude of the actual difference, is
\textsc{ok}:
\begin{cpplisting}
double absdiff_testudo(MyVector const &mv1,
                       MyVector const &mv2) {
  double dx=mv1.x-mv2.y;
  double dy=mv1.y-mv2.y;
  return abs(dx)+abs(dy); // this is also \textsc{ok}
}
\end{cpplisting}

You may have to use ``\texttt{testudo::absdiff\_testudo()}'' on other values
contained in your type:
\begin{cpplisting}
template <typename T>
class MyPair {
public:
  ...
  T first, second;
};
template <typename T>
double absdiff_testudo(MyPair<T> const &mp1,
                       MyPair<T> const &mp2) {
  return (testudo::absdiff(mp1.first, mp2.first)
          +testudo::absdiff(mp1.second, mp2.second));
}
\end{cpplisting}


\cleartooddpage

\appendices

\chapter{Testudo installation}
\label{cha:testudo-installation}

Dependencies:
\begin{itemize}
\item a \Cpp{}17 compiler (duh);
\item \texttt{bash}, \texttt{sed}, \texttt{awk} (used by scripts);
\item \texttt{m4} (for generation of ``\texttt{mock\_turtle\_macro\_n.h}'');
\item \texttt{make} (but you can use your own alternative);
\item \texttt{xsltproc} (for \textsc{xml}-to-coloured-text translation);
\item \LaTeX{}, \texttt{rubber} (to generate the \textsc{pdf} documentation).
\end{itemize}

Run:
\begin{itemize}
\item ``\texttt{make diff\_test}'' to diff-check the
  \textsc{xml}-to-coloured-text output against the expected result;
\item ``\texttt{make diff\_tests}'' to diff-check the
  \textsc{xml}-to-coloured-text output against the expected result and against
  direct-to-coloured-text output;
\item ``\texttt{make}'' to generate the \textsc{pdf} documentation.
\end{itemize}


\chapter{Editor configuration}
\label{cha:editor-configuration}

You can configure your editor to colour Testudo keywords (as defined by the
test style file you're using).  For Emacs, if you have a style file named
``\texttt{mystyle.txt}'', do ``\texttt{make
  emacs\_add\_keywords\_mystyle.txt}'' and you'll get a text file named
``\texttt{emacs\_add\_keywords\_mystyle.txt}'' containing the appropriate
customization expression for your ``\texttt{.emacs}'' file.


\chapter{Using your own test macro names}
\label{cha:using-your-own-test-macro-names}

You can define your own style for Testudo macros, so macro names suit your
exact needs and taste.  You just have to copy one of the two provided style
files, ``\texttt{lc.tst}'' or ``\texttt{cp.tst}'', into a file of your own with
the ``\texttt{.tst}'' extension, say ``\texttt{mystyle.tst}'', and customize
the second half of each line, which is the macro name.  Then, instead of
including ``\texttt{testudo\_lc.h}'' or ``\texttt{testudo\_lc.h}'', include
``\texttt{testudo\_mystyle.h}''.

Here's an example where we adapt the macro names to be in Esperanto.  The
``\texttt{eo.tst}'' file is shown in~\fref{fig:esperanto-style}, and this is a
test specified with that style:
\begin{cpplisting}
difini_teston(esperanto_test, numbers, "numbers") {
  deklari(auto const dictionary=vortaro);
  certigi(dictionary.at("unu"))_egalas(1);
}
\end{cpplisting}

\begin{figure}
  \centering
  \framebox{\begin{minipage}{.75\columnwidth}
  \begin{footnotesize}
    \verbatiminput{eo.tst}
  \end{footnotesize}
  \end{minipage}}
  \caption{Definition of an Esperanto style in file ``\texttt{eo.tst}''}
  \label{fig:esperanto-style}
\end{figure}

\backmatter


\end{document}
%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
